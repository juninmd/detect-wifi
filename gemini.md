# Presence Detector - Development Best Practices (Gemini)

This document outlines the coding standards, architectural patterns, and best practices for the Presence Detector project. It serves as a guide for AI assistants (like Gemini) and developers to ensure consistency and quality.

## 1. Architecture

### Service-Based Architecture
The application relies heavily on Android Services for continuous monitoring.
*   **Foreground Services:** All monitoring services (`AntiTheftService`, `DetectionBackgroundService`) must run as foreground services to ensure system priority.
*   **Service Types:** For Android 14+ (API 34+), you must specify the `foregroundServiceType` in the manifest and `ServiceCompat.startForeground`.
    *   `location`: For WiFi/BLE scanning.
    *   `specialUse` or `camera`: For anti-theft monitoring (depending on specific use case and Google Play policies).

### Manager Pattern
Use Singleton "Manager" classes to coordinate logic between Services and UI.
*   `PresenceDetectionManager`: Central hub for presence events.
*   `BiometricAuthenticator`: Encapsulates authentication logic.

**Rule:** Services should be "dumb" collectors; Managers should handle the business logic and state.

## 2. Coding Standards

### Kotlin
*   **Language Version:** Use Kotlin 1.9+.
*   **Coroutines:** Use `Coroutines` for all asynchronous operations (DB, Network, fast-processing). Avoid `AsyncTask` or raw `Threads`.
    *   Scope: Use `lifecycleScope` in Activities/Fragments and `ServiceLifecycleScope` (or `CoroutineScope` with proper cancellation) in Services.
    *   Dispatchers: Use `Dispatchers.IO` for network/disk, `Dispatchers.Main` for UI updates.

### Code Style
*   **ViewBinding:** Use ViewBinding for all UI interactions. Do not use `findViewById`.
*   **Logging:** Use `LoggerUtil` instead of raw `Log.d/e`. This allows for centralized log management and potential export features.
*   **Hardcoding:** Avoid hardcoding strings and dimensions. Use `strings.xml` and `dimens.xml`.

## 3. Android Compliance & Compatibility

### Permissions
*   **Runtime Permissions:** Always check and request permissions at runtime.
*   **Background Location:** For Android 10+ (API 29+), `ACCESS_BACKGROUND_LOCATION` must be requested *after* foreground location permission is granted.
*   **Notifications:** Android 13+ (API 33+) requires `POST_NOTIFICATIONS`.

### API Levels
*   **Min SDK:** 24 (Android 7.0) - *Check build.gradle for current value*.
*   **Target SDK:** 35 (Android 15).
*   **Backward Compatibility:** Use `ContextCompat`, `ServiceCompat`, and version checks (`Build.VERSION.SDK_INT`) to support older devices while using new features.

## 4. Security

### Sensitive Data
*   **Credentials:** Never commit API keys or passwords. Use `local.properties` or environment variables for build-time injection, and encrypted SharedPreferences (or `EncryptedFile`) for runtime storage if needed.
*   **Biometrics:** Use `BiometricPrompt` for critical actions (like disarming the alarm). Do not rely solely on simple toggles for security features.

### Network
*   **Telegram:** Ensure bot tokens are secured.

## 5. Testing

### Unit Tests
*   Location: `app/src/test/java`
*   Frameworks: JUnit 4, Mockito.
*   Scope: Test utility classes (`NotificationUtil`), Managers (mocking dependencies), and data parsers.

### Instrumentation Tests
*   Location: `app/src/androidTest/java`
*   Frameworks: Espresso, AndroidJUnitRunner.
*   Scope: UI flows, Service lifecycles (harder to test, use with caution).

## 6. Git & Version Control

*   **Commit Messages:** Descriptive messages (e.g., "feat: Add MQTT support", "fix: Crash on Android 14 service start").
*   **Branches:** Use feature branches (`feature/xyz`) or bugfix branches (`fix/issue-123`).
*   **Pull Requests:** Review code for compliance with these practices before merging.

## 7. Specific Feature Implementation Details

### Anti-Theft
*   **Motion:** Uses Accelerometer.
*   **Pocket:** Uses Proximity sensor.
*   **Charger:** Uses Power connection broadcast receiver.
*   *Note:* State must be persisted in `PreferencesUtil` to survive service restarts.

### Presence Detection
*   **WiFi:** Uses `WifiManager.startScan()`. Note throttling limits on Android 9+.
*   **Camera:** Uses `LibVLC` or `Camera2` API for motion detection.

---
*Generated by Jules (AI Agent) - Jan 2026*
